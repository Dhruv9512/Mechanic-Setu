# Use a slim, official Python image for a smaller and faster build
FROM python:3.10-slim-bookworm

# Set environment variables for Python
ENV PYTHONDONTWRITEBYTECODE 1
ENV PYTHONUNBUFFERED 1

# Install system dependencies AND APPLY SECURITY UPGRADES
RUN apt-get update && apt-get upgrade -y && apt-get install -y --no-install-recommends \
    build-essential \
    pkg-config \
    libmariadb-dev \
    libmariadb-dev-compat \
    tini \
    # Clean up apt cache to keep the image small
    && rm -rf /var/lib/apt/lists/*

# Set the working directory
WORKDIR /app

# Copy and install Python requirements
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# Copy the rest of your application code
COPY . .

# Ensure your startup script is executable
COPY entry-point.sh /app/entry-point.sh
RUN chmod +x /app/entry-point.sh

# Expose the port your application runs on
EXPOSE 8000

# Use tini for proper process management
ENTRYPOINT ["/usr/bin/tini", "--"]

# Run your application via the entrypoint script
CMD ["/app/entry-point.sh"]
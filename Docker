# Use Miniconda as the base image
FROM continuumio/miniconda3

# Install system dependencies
RUN apt-get update && apt-get install -y \
    pkg-config \
    libmariadb-dev \
    libmariadb-dev-compat \
    build-essential \
    tini \
    libgtk-3-dev \
    && rm -rf /var/lib/apt/lists/*

# Set the working directory
WORKDIR /app

# Copy environment.yml into the container
COPY environment.yml /app/

# Create the Conda environment AND clean it up in the same step
# This reduces the size of the final Docker image layer
RUN conda env create -f /app/environment.yml && \
    conda clean -a -y

# Set environment variables to activate the Conda environment
ENV PATH /opt/conda/envs/myenv/bin:$PATH
ENV DEBIAN_FRONTEND=noninteractive

# Ensure Conda is properly initialized in non-interactive shells
RUN echo "source /opt/conda/etc/profile.d/conda.sh" >> ~/.bashrc

# Activate Conda in the image
SHELL ["conda", "run", "-n", "myenv", "/bin/bash", "-c"]

# Copy the application code
COPY . /app/

# Ensure entrypoint script is copied and executable
COPY entrypoint.sh /app/entrypoint.sh
RUN chmod +x /app/entrypoint.sh

# Expose the port Django runs on
EXPOSE 8000

# Use tini as the entrypoint for better process management
ENTRYPOINT ["/usr/bin/tini", "--"]

# Run your application via the entrypoint script
CMD ["/app/entrypoint.sh"]